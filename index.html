<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>üéÑ Locked Till Morning üéÑ</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(10,14,18,.86);
      --panel2:rgba(16,22,34,.82);
      --text:#e9eefc;
      --muted:#aab6d6;
      --accent:#7bdcff;
      --good:#67f0a5;
      --warn:#ffd36b;
      --bad:#ff6b7a;
      --shadow:0 14px 40px rgba(0,0,0,.45);
      --radius:18px;
      --btn:#1c2a44;
      --btn2:#24365a;
      --btn3:#2d4474;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; background:radial-gradient(1200px 700px at 50% 0%, #172a54 0%, #0b1220 55%, #070b14 100%); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{overflow:hidden;}

    #wrap{position:fixed; inset:0; display:flex; align-items:stretch; justify-content:center;}
    #game{
      width:100vw; height:100vh;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background:#0b1220;
      display:block;
      touch-action:none;
    }

    .screen{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      padding:18px;
      background:radial-gradient(1000px 700px at 50% 0%, rgba(255,255,255,.08) 0%, rgba(0,0,0,.58) 55%, rgba(0,0,0,.8) 100%);
      z-index:20;
    }
    .screen.show{display:flex;}
    .card{
      width:min(920px, 94vw);
      max-height:92vh;
      overflow:auto;
      background:linear-gradient(180deg, rgba(20,28,48,.88), rgba(12,16,26,.86));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .title{
      font-weight:900; letter-spacing:.3px;
      font-size:clamp(28px, 4.6vw, 44px);
      margin:0 0 6px 0;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .subtitle{margin:0 0 14px 0; color:var(--muted); line-height:1.4;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .spacer{height:12px;}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:12px 0;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background:rgba(123,220,255,.10); border:1px solid rgba(123,220,255,.22);
      color:#dff6ff; font-weight:700; font-size:13px;
    }
    .badge.good{background:rgba(103,240,165,.10); border-color:rgba(103,240,165,.22);}
    .badge.warn{background:rgba(255,211,107,.10); border-color:rgba(255,211,107,.22);}
    .badge.bad{background:rgba(255,107,122,.10); border-color:rgba(255,107,122,.22);}

    .btn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      background:linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.35);
      transition:transform .08s ease, filter .15s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px) scale(.99); filter:brightness(1.06);}
    .btn.ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); box-shadow:none;}
    .btn.good{background:linear-gradient(180deg, #2b7a5a, #1e5640);}
    .btn.bad{background:linear-gradient(180deg, #7a2b3b, #561e2a);}
    .btn.small{padding:10px 12px; border-radius:12px; font-weight:800; font-size:14px;}
    .btn.wide{min-width:220px;}
    .inp, select{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-weight:700;
      min-width:220px;
    }
    .muted{color:var(--muted);}
    .tiny{font-size:13px; color:var(--muted);}

    .serverRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      margin:10px 0;
    }

    #hud{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:10;
    }
    .hudTop{
      position:absolute; left:10px; top:10px;
      display:flex; flex-direction:column; gap:8px;
      pointer-events:none;
    }
    .hudBar{
      width:min(420px, 92vw);
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 10px;
      backdrop-filter:blur(6px);
    }
    .barRow{display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:900;}
    .barLine{
      height:10px; border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      margin-top:8px;
    }
    .barFill{height:100%; width:50%; background:linear-gradient(90deg, rgba(123,220,255,.95), rgba(103,240,165,.95));}
    .barFill.hp{background:linear-gradient(90deg, rgba(255,107,122,.95), rgba(255,211,107,.95));}
    .barFill.hun{background:linear-gradient(90deg, rgba(255,211,107,.95), rgba(123,220,255,.75));}
    .barFill.thr{background:linear-gradient(90deg, rgba(123,220,255,.95), rgba(123,220,255,.55));}
    .barFill.sta{background:linear-gradient(90deg, rgba(103,240,165,.95), rgba(123,220,255,.65));}

    #controls{
      position:absolute; inset:0;
      pointer-events:none;
    }
    .pad{
      position:absolute; left:12px; bottom:12px;
      width:170px; height:170px;
      pointer-events:auto;
      opacity:.95;
    }
    .padGrid{
      position:absolute; inset:0;
      display:grid; grid-template-columns:repeat(3, 1fr); grid-template-rows:repeat(3, 1fr);
      gap:10px;
    }
    .padBtn{
      border-radius:18px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000; color:#e9eefc;
      user-select:none;
      touch-action:none;
    }
    .padBtn:active{filter:brightness(1.2); transform:scale(.99);}
    .padBtn.empty{background:transparent; border-color:transparent;}

    .rightStack{
      position:absolute; right:12px; bottom:12px;
      display:flex; flex-direction:column; gap:10px;
      pointer-events:auto;
    }
    .actionBtn{
      width:160px;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:#e9eefc;
      font-weight:1000;
      user-select:none;
      touch-action:none;
    }
    .actionBtn:active{filter:brightness(1.2); transform:scale(.99);}
    .actionBtn.good{background:rgba(103,240,165,.16); border-color:rgba(103,240,165,.22);}
    .actionBtn.bad{background:rgba(255,107,122,.16); border-color:rgba(255,107,122,.22);}

    #invTray{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:12px;
      display:flex; gap:10px;
      pointer-events:auto;
      padding:8px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      backdrop-filter:blur(6px);
      max-width:92vw;
      overflow:auto;
    }
    .slot{
      min-width:86px; padding:10px;
      border-radius:16px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      display:flex; flex-direction:column; gap:6px;
      align-items:center; justify-content:center;
      user-select:none;
      touch-action:none;
    }
    .slot:active{filter:brightness(1.2);}
    .slotName{font-weight:900; font-size:12px; text-align:center; color:#e9eefc;}
    .slotQty{font-weight:900; font-size:12px; color:var(--muted);}

    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      top:14px; z-index:50;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
      color:#fff;
      font-weight:900;
      display:none;
      max-width:92vw;
      text-align:center;
      backdrop-filter:blur(6px);
    }

    @media (max-width: 430px){
      .pad{width:150px; height:150px;}
      .actionBtn{width:146px;}
      .slot{min-width:78px;}
    }
  </style>
</head>

<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <div id="hud">
    <div class="hudTop">
      <div class="hudBar">
        <div class="barRow">
          <div id="timeText">12:00 AM</div>
          <div class="badge warn" id="diffBadge">Easy</div>
        </div>
        <div class="tiny" id="goalText">Survive until 8:00 AM ‚Ä¢ 1 sec = 1 min</div>
      </div>

      <div class="hudBar">
        <div class="barRow"><div>Health</div><div id="hpText">100</div></div>
        <div class="barLine"><div class="barFill hp" id="hpFill"></div></div>

        <div class="spacer"></div>

        <div class="barRow"><div>Hunger</div><div id="hunText">100</div></div>
        <div class="barLine"><div class="barFill hun" id="hunFill"></div></div>

        <div class="spacer"></div>

        <div class="barRow"><div>Thirst</div><div id="thrText">100</div></div>
        <div class="barLine"><div class="barFill thr" id="thrFill"></div></div>

        <div class="spacer"></div>

        <div class="barRow"><div>Stamina</div><div id="staText">100</div></div>
        <div class="barLine"><div class="barFill sta" id="staFill"></div></div>

        <div class="spacer"></div>

        <div class="tiny" id="hideHint">Hide near lockers / plants / behind kiosks</div>
      </div>
    </div>

    <div id="controls">
      <div class="pad">
        <div class="padGrid">
          <div class="padBtn empty"></div>
          <div class="padBtn" data-key="up">‚ñ≤</div>
          <div class="padBtn empty"></div>

          <div class="padBtn" data-key="left">‚óÄ</div>
          <div class="padBtn empty"></div>
          <div class="padBtn" data-key="right">‚ñ∂</div>

          <div class="padBtn empty"></div>
          <div class="padBtn" data-key="down">‚ñº</div>
          <div class="padBtn empty"></div>
        </div>
      </div>

      <div class="rightStack">
        <div class="actionBtn good" id="sprintHoldBtn">HOLD TO SPRINT</div>
        <div class="actionBtn" id="hideBtn">HIDE</div>
        <div class="actionBtn" id="useBtn">USE / PICKUP</div>
        <div class="actionBtn bad" id="pauseBtn">MENU</div>
      </div>

      <div id="invTray"></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- ===== MENU ===== -->
<div class="screen show" id="menuScreen">
  <div class="card">
    <div class="title">üéÑ Locked Till Morning üéÑ <span class="badge good">Christmas Update</span></div>
    <p class="subtitle">
      Pixel-art mall survival. You‚Äôre locked in after closing. Avoid employees and survive until <b>8:00 AM</b> when the mall opens.
      <br><span class="tiny">Clock: 1 real second = 1 in-game minute (8 minutes to win).</span>
    </p>

    <div class="row">
      <div>
        <div class="tiny">Your name (saved):</div>
        <input class="inp" id="nameInput" maxlength="18" />
      </div>

      <div>
        <div class="tiny">Difficulty:</div>
        <select id="diffSelect">
          <option value="easy">Easy</option>
          <option value="medium" disabled>Medium (unlock: survive 5x)</option>
          <option value="hard" disabled>Hard (unlock: survive 10x)</option>
          <option value="santa">üéÖ Santa (find 5 ornaments) ‚Äî leaves Jan 11</option>
        </select>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <button class="btn wide good" id="playSoloBtn">Play (Solo)</button>
      <button class="btn wide" id="multiBtn">Multiplayer</button>
      <button class="btn wide ghost" id="howBtn">How To Play</button>
      <button class="btn wide ghost" id="statsBtn">Stats</button>
    </div>

    <div class="hr"></div>

    <div class="row">
      <span class="badge warn">üéÅ Tip:</span>
      <span class="muted">‚ÄúMeet Santa‚Äù area is the center atrium (no Santa). Cookies + milk spawn there.</span>
    </div>
    <div class="spacer"></div>
    <div class="tiny">
      Note: Santa Difficulty + decorations leave on <b>January 11</b> (you can keep it anyway ‚Äî it‚Äôs just a note).
    </div>
  </div>
</div>

<!-- ===== HOW ===== -->
<div class="screen" id="howScreen">
  <div class="card">
    <div class="title">How To Play</div>
    <div class="subtitle">
      - Survive from <b>12:00 AM</b> to <b>8:00 AM</b>.<br>
      - Employees patrol. If one spots you, they chase and hit for <b>30 damage</b>.<br>
      - Keep <b>Hunger</b> and <b>Thirst</b> up. If they hit 0, your health starts draining.<br>
      - Sprint by <b>holding</b> the Sprint button. Sprint uses stamina. Stamina refills when you walk / rest.<br>
      - Food & drinks go into your <b>inventory</b>. Tap an item slot to use it.<br>
      - Drinks give stamina <b>except sodas</b>.<br>
      - Hide near hiding spots: lockers, plants, kiosks. Press <b>HIDE</b> to tuck in.
    </div>
    <div class="row">
      <button class="btn" id="howBackBtn">Back</button>
    </div>
  </div>
</div>

<!-- ===== STATS ===== -->
<div class="screen" id="statsScreen">
  <div class="card">
    <div class="title">Stats</div>
    <div class="subtitle" id="statsText"></div>
    <div class="row">
      <button class="btn" id="statsBackBtn">Back</button>
      <button class="btn bad" id="resetBtn">Reset Save (local)</button>
    </div>
  </div>
</div>

<!-- ===== PAUSE ===== -->
<div class="screen" id="pauseScreen">
  <div class="card">
    <div class="title">Menu</div>
    <p class="subtitle" id="pauseInfo"></p>
    <div class="row">
      <button class="btn good" id="resumeBtn">Resume</button>
      <button class="btn" id="quitBtn">Quit to Menu</button>
      <button class="btn ghost" id="mpLeaveBtn" style="display:none;">Leave Multiplayer</button>
    </div>
  </div>
</div>

<!-- ===== MULTIPLAYER ===== -->
<div class="screen" id="multiScreen">
  <div class="card">
    <div class="title">Multiplayer (Worldwide)</div>
    <p class="subtitle">
      Host creates a server. Others join from the list. Host can start when at least 2 players are in the lobby.
    </p>

    <div class="row">
      <button class="btn good" id="hostBtn">Host</button>
      <button class="btn" id="joinBtn">Join</button>
      <button class="btn ghost" id="multiBackBtn">Back</button>
    </div>

    <div class="hr"></div>

    <div id="hostPanel" style="display:none;">
      <div class="row">
        <div>
          <div class="tiny">Max players:</div>
          <select id="maxPlayersSelect">
            <option value="2">2 players</option>
            <option value="3">3 players</option>
            <option value="4" selected>4 players</option>
            <option value="5">5 players</option>
            <option value="6">6 players</option>
          </select>
        </div>

        <div>
          <div class="tiny">Difficulty:</div>
          <select id="hostDiffSelect">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
            <option value="santa">üéÖ Santa</option>
          </select>
        </div>

        <button class="btn good" id="createServerBtn">Create</button>
      </div>
      <div class="spacer"></div>
      <div class="tiny muted">After creating, you‚Äôll go to the lobby.</div>
    </div>

    <div id="joinPanel" style="display:none;">
      <div class="row">
        <button class="btn small" id="refreshServersBtn">Refresh</button>
        <span class="tiny muted">Tap Join next to a server.</span>
      </div>
      <div id="serverList"></div>
    </div>
  </div>
</div>

<!-- ===== LOBBY ===== -->
<div class="screen" id="lobbyScreen">
  <div class="card">
    <div class="title">Lobby</div>
    <p class="subtitle" id="lobbyInfo"></p>
    <div class="hr"></div>
    <div id="playerList"></div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn good" id="hostStartBtn" style="display:none;">Start Game</button>
      <button class="btn bad" id="lobbyLeaveBtn">Leave</button>
    </div>
    <div class="spacer"></div>
    <div class="tiny muted">Tip: If you close the tab, you auto-leave.</div>
  </div>
</div>

<script type="module">
/* =========================================================
   LOCKED TILL MORNING ‚Äî SINGLE FILE (FIXED)
   ‚úÖ IMPORTANT FIXES:
   1) Only ONE Firebase setup (no duplicate scripts)
   2) HOLD-TO-SPRINT works while moving (multi-touch safe)
   ========================================================= */

/* =========================
   Firebase (YOUR CONFIG)
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, set, update, get, onValue, onDisconnect,
  remove, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnwWcA5NCQWmgeePIN-CzUZx7hr8wq_iE",
  authDomain: "locked-till-morning.firebaseapp.com",
  databaseURL: "https://locked-till-morning-default-rtdb.firebaseio.com",
  projectId: "locked-till-morning",
  storageBucket: "locked-till-morning.firebasestorage.app",
  messagingSenderId: "148695967920",
  appId: "1:148695967920:web:41553031e9084491e13375"
  // measurementId optional (not needed for this game)
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const lerp = (a,b,t)=>a+(b-a)*t;
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

let toastTimer=null;
function toast(msg){
  const el=$("toast");
  el.textContent=msg;
  el.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.style.display="none", 1600);
}

/* =========================
   Save (localStorage)
========================= */
const SAVE_KEY="LTM_SAVE_V1";
const defaultSave = ()=>({
  name: "Player" + String(Math.floor(Math.random()*10000)).padStart(4,"0"),
  totalPlaySeconds: 0,
  survivedTotal: 0,
  survivedStreak: 0,
  bestStreak: 0,
  unlocks: { medium:false, hard:false },
  lastDifficulty: "easy"
});
function loadSave(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return defaultSave();
    const s=JSON.parse(raw);
    return { ...defaultSave(), ...s, unlocks:{...defaultSave().unlocks, ...(s.unlocks||{})} };
  }catch{ return defaultSave(); }
}
function saveNow(){ localStorage.setItem(SAVE_KEY, JSON.stringify(SAVE)); refreshMenuLocks(); }
let SAVE = loadSave();

/* =========================
   Game constants
========================= */
const TILE=16;
const WORLD_W=120;
const WORLD_H=80;
const VIEW_TILES_X=24;
const VIEW_TILES_Y=14;

const DAY_START_MIN=0;
const DAY_END_MIN=8*60;
const REAL_SEC_PER_INGAME_MIN=1;

/* =========================
   Difficulty tuning
========================= */
function diffParams(key){
  if(key==="easy")   return { enemySpeed: 0.70, enemySight: 4.8, enemyCount: 3, hungerDrain: 0.08, thirstDrain:0.10, staminaDrain:0.70, staminaRegen:0.95 };
  if(key==="medium") return { enemySpeed: 0.85, enemySight: 5.6, enemyCount: 4, hungerDrain: 0.10, thirstDrain:0.12, staminaDrain:0.78, staminaRegen:0.90 };
  if(key==="hard")   return { enemySpeed: 1.00, enemySight: 6.2, enemyCount: 5, hungerDrain: 0.12, thirstDrain:0.15, staminaDrain:0.86, staminaRegen:0.84 };
  if(key==="santa")  return { enemySpeed: 0.88, enemySight: 5.8, enemyCount: 4, hungerDrain: 0.10, thirstDrain:0.12, staminaDrain:0.78, staminaRegen:0.90 };
  return diffParams("easy");
}

/* =========================
   Canvas setup
========================= */
const canvas=$("game");
const ctx=canvas.getContext("2d", { alpha:false });
function resize(){
  canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  canvas.height= Math.floor(window.innerHeight * devicePixelRatio);
}
window.addEventListener("resize", resize, {passive:true});
resize();

/* =========================
   Map generation (pixel mall)
========================= */
const T={
  FLOOR:0, CARPET:1, WALL:2, GLASS:3, DOOR:4, SHOP:5, KIOSK:6, PLANT:7, LOCKER:8, TREE:9, TABLE:10
};

const tile = new Uint8Array(WORLD_W*WORLD_H);
const solid = new Uint8Array(WORLD_W*WORLD_H);
const hideSpot = new Uint8Array(WORLD_W*WORLD_H);
const items = [];

function idx(x,y){ return y*WORLD_W + x; }
function inb(x,y){ return x>=0 && y>=0 && x<WORLD_W && y<WORLD_H; }

function fillRect(x0,y0,w,h, val, sol=0){
  for(let y=y0;y<y0+h;y++){
    for(let x=x0;x<x0+w;x++){
      if(!inb(x,y)) continue;
      tile[idx(x,y)] = val;
      if(sol) solid[idx(x,y)] = 1;
    }
  }
}
function outlineRect(x0,y0,w,h,val,sol=1){
  for(let x=x0;x<x0+w;x++){
    if(inb(x,y0)){ tile[idx(x,y0)]=val; if(sol) solid[idx(x,y0)]=1; }
    if(inb(x,y0+h-1)){ tile[idx(x,y0+h-1)]=val; if(sol) solid[idx(x,y0+h-1)]=1; }
  }
  for(let y=y0;y<y0+h;y++){
    if(inb(x0,y)){ tile[idx(x0,y)]=val; if(sol) solid[idx(x0,y)]=1; }
    if(inb(x0+w-1,y)){ tile[idx(x0+w-1,y)]=val; if(sol) solid[idx(x0+w-1,y)]=1; }
  }
}
function placeProp(x,y, t, canHide=false){
  if(!inb(x,y)) return;
  tile[idx(x,y)] = t;
  solid[idx(x,y)] = 1;
  if(canHide) hideSpot[idx(x,y)] = 1;
}
function rand(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
function spawnItem(x,y, kind){ items.push({x,y,kind, taken:false}); }

function buildMall(){
  fillRect(0,0,WORLD_W,WORLD_H, T.FLOOR, 0);
  outlineRect(0,0,WORLD_W,WORLD_H, T.WALL, 1);

  fillRect(10, 35, 100, 10, T.CARPET, 0);
  fillRect(55, 10, 10, 60, T.CARPET, 0);
  fillRect(45, 28, 30, 24, T.CARPET, 0);

  const shops = [
    {x:6,y:6,w:22,h:18},{x:34,y:6,w:18,h:18},{x:70,y:6,w:22,h:18},{x:96,y:6,w:18,h:18},
    {x:6,y:52,w:22,h:22},{x:34,y:56,w:18,h:18},{x:70,y:56,w:22,h:18},{x:96,y:52,w:18,h:22},
  ];
  for(const s of shops){
    fillRect(s.x+1,s.y+1,s.w-2,s.h-2, T.SHOP, 0);
    outlineRect(s.x,s.y,s.w,s.h, T.WALL, 1);

    const doorX = s.x + Math.floor(s.w/2);
    const doorY = (s.y < 30) ? (s.y+s.h-1) : (s.y);
    if(inb(doorX,doorY)){
      tile[idx(doorX,doorY)] = T.DOOR;
      solid[idx(doorX,doorY)] = 0;
      if(inb(doorX-1,doorY)){ tile[idx(doorX-1,doorY)] = T.GLASS; solid[idx(doorX-1,doorY)] = 1; }
      if(inb(doorX+1,doorY)){ tile[idx(doorX+1,doorY)] = T.GLASS; solid[idx(doorX+1,doorY)] = 1; }
    }

    for(let i=0;i<rand(2,4);i++) placeProp(rand(s.x+2,s.x+s.w-3), rand(s.y+2,s.y+s.h-3), T.LOCKER, true);
    for(let i=0;i<rand(1,3);i++) placeProp(rand(s.x+2,s.x+s.w-3), rand(s.y+2,s.y+s.h-3), T.PLANT, true);
  }

  for(const k of [{x:30,y:37},{x:40,y:40},{x:78,y:38},{x:86,y:42},{x:58,y:22},{x:60,y:58}]){
    placeProp(k.x,k.y, T.KIOSK, true);
    if(inb(k.x+1,k.y)) placeProp(k.x+1,k.y, T.TABLE, false);
  }

  for(const p of [{x:46,y:29},{x:72,y:29},{x:46,y:50},{x:72,y:50},{x:56,y:28},{x:62,y:28},{x:56,y:51},{x:62,y:51}]){
    placeProp(p.x,p.y, T.TREE, true);
  }

  for(let i=0;i<20;i++) placeProp(rand(12,108), rand(12,68), (Math.random()<0.5?T.PLANT:T.LOCKER), true);

  const foods=["chips","burger","cookie","pizza","sandwich"];
  const drinks=["water","juice","milk","soda","sports"];
  for(let i=0;i<28;i++) spawnItem(rand(8,112), rand(8,72), {type:"food", name:foods[rand(0,foods.length-1)]});
  for(let i=0;i<24;i++) spawnItem(rand(8,112), rand(8,72), {type:"drink", name:drinks[rand(0,drinks.length-1)]});

  for(let i=0;i<8;i++) spawnItem(rand(50,70), rand(32,48), {type:"food", name:"cookie"});
  for(let i=0;i<5;i++) spawnItem(rand(50,70), rand(32,48), {type:"drink", name:"milk"});

  for(let i=0;i<5;i++) spawnItem(rand(10,110), rand(10,70), {type:"ornament", name:"ornament"});
}
buildMall();

/* =========================
   Player / Inventory
========================= */
const player = {
  x: 14, y: 14,
  vx:0, vy:0,
  speed: 1.15,
  health: 100,
  hunger: 100,
  thirst: 100,
  stamina: 100,
  hidden: false,
  hideCooldown: 0,
  damageCooldown: 0,
  ornaments: 0
};

const inv = {
  slots: [
    {key:"food", label:"Food", items:{}},
    {key:"drink", label:"Drink", items:{}},
    {key:"misc", label:"Misc", items:{}},
  ]
};

function invAdd(kind){
  let slot = inv.slots[2];
  if(kind.type==="food") slot=inv.slots[0];
  if(kind.type==="drink") slot=inv.slots[1];
  if(kind.type==="ornament") slot=inv.slots[2];

  slot.items[kind.name] = (slot.items[kind.name]||0)+1;
  toast(`Picked up ${kind.name}!`);
  renderInv();
}

function invUse(slotIndex){
  const slot=inv.slots[slotIndex];
  const names=Object.keys(slot.items);
  if(!names.length) return toast("Empty.");
  const name = names[0];
  slot.items[name]--;
  if(slot.items[name]<=0) delete slot.items[name];

  if(slot.key==="food"){
    const hungerGain = (name==="cookie") ? 12 : 18;
    player.hunger = clamp(player.hunger + hungerGain, 0, 100);
    player.health = clamp(player.health + 2, 0, 100);
    toast(`Ate ${name}`);
  }else if(slot.key==="drink"){
    const thirstGain = (name==="water")?26 : (name==="milk"?22 : 18);
    player.thirst = clamp(player.thirst + thirstGain, 0, 100);
    if(name!=="soda"){
      player.stamina = clamp(player.stamina + 18, 0, 100);
      toast(`Drank ${name}`);
    }else{
      toast(`Drank soda`);
    }
  }else{
    if(name==="ornament"){
      player.ornaments = clamp(player.ornaments + 1, 0, 5);
      toast(`Ornament found! (${player.ornaments}/5)`);
    }else{
      toast(`Used ${name}`);
    }
  }
  renderInv();
}

function renderInv(){
  const tray=$("invTray");
  tray.innerHTML="";
  inv.slots.forEach((s,i)=>{
    const names=Object.keys(s.items);
    const top = names[0] || s.label;
    const qty = names.length ? ("x"+s.items[top]) : "‚Äî";
    const el=document.createElement("div");
    el.className="slot";
    el.innerHTML = `<div class="slotName">${esc(top)}</div><div class="slotQty">${esc(qty)}</div>`;
    el.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      if(!game.playing) return;
      invUse(i);
    }, {passive:false});
    tray.appendChild(el);
  });
}

/* =========================
   Enemies (employees)
========================= */
function makeEnemy(x,y, variant){
  return { x,y, vx:0, vy:0, mode:"patrol", tx:x, ty:y, spotTimer:0, hitCooldown:0, variant };
}
let enemies=[];

/* =========================
   Game state
========================= */
const game = {
  playing:false,
  paused:false,
  inMenu:true,
  difficultyKey:"easy",
  params: diffParams("easy"),
  inGameMinute: 0,
  lastTick: performance.now(),
  playSecondsThisRun: 0,
  multiplayer:false,
  mp: {
    enabled:false,
    roomId:null,
    isHost:false,
    hostId:null,
    playerId: localStorage.getItem("ltm_pid") || ("p_" + crypto.getRandomValues(new Uint32Array(4)).join("_")),
    roomsUnsub:null,
    roomUnsub:null,
    otherPlayers:{}
  }
};
localStorage.setItem("ltm_pid", game.mp.playerId);

/* =========================
   Screens
========================= */
function showScreen(id){
  ["menuScreen","howScreen","statsScreen","pauseScreen","multiScreen","lobbyScreen"].forEach(s=>$(s).classList.remove("show"));
  if(id) $(id).classList.add("show");
}
function refreshMenuLocks(){
  $("nameInput").value = SAVE.name;

  const diffSel=$("diffSelect");
  const med=diffSel.querySelector('option[value="medium"]');
  const hard=diffSel.querySelector('option[value="hard"]');
  med.disabled = !SAVE.unlocks.medium;
  hard.disabled = !SAVE.unlocks.hard;

  if(diffSel.value==="medium" && med.disabled) diffSel.value="easy";
  if(diffSel.value==="hard" && hard.disabled) diffSel.value="easy";
}
refreshMenuLocks();

/* =========================
   Time formatting
========================= */
function formatTimeFromMinutes(m){
  const total = m % (24*60);
  let h = Math.floor(total/60);
  const min = total%60;
  const am = h<12;
  let hh = h%12; if(hh===0) hh=12;
  return `${hh}:${String(min).padStart(2,"0")} ${am?"AM":"PM"}`;
}

/* =========================
   Controls (FIXED hold sprint + multi-touch)
========================= */
const keys = {up:false,down:false,left:false,right:false};
let sprintHeld=false;

// stop iOS page scroll / zoom during game button touches
document.addEventListener("touchmove",(e)=>{ if(game.playing && !game.paused) e.preventDefault(); }, {passive:false});

function bindPad(){
  document.querySelectorAll(".padBtn").forEach(btn=>{
    const k=btn.getAttribute("data-key");
    if(!k) return;

    const down = (e)=>{ e.preventDefault(); e.stopPropagation(); keys[k]=true; };
    const up   = (e)=>{ e.preventDefault(); e.stopPropagation(); keys[k]=false; };

    btn.addEventListener("pointerdown", down, {passive:false});
    btn.addEventListener("pointerup", up, {passive:false});
    btn.addEventListener("pointercancel", up, {passive:false});
    btn.addEventListener("pointerleave", up, {passive:false});
  });

  // HOLD-TO-SPRINT (multi-touch safe)
  const sBtn=$("sprintHoldBtn");
  const sDown=(e)=>{ e.preventDefault(); e.stopPropagation(); sprintHeld=true; sBtn.textContent="SPRINTING..."; };
  const sUp  =(e)=>{ e.preventDefault(); e.stopPropagation(); sprintHeld=false; sBtn.textContent="HOLD TO SPRINT"; };
  sBtn.addEventListener("pointerdown", sDown, {passive:false});
  sBtn.addEventListener("pointerup", sUp, {passive:false});
  sBtn.addEventListener("pointercancel", sUp, {passive:false});
  sBtn.addEventListener("pointerleave", sUp, {passive:false});

  $("hideBtn").addEventListener("pointerdown",(e)=>{ e.preventDefault(); e.stopPropagation(); if(game.playing) toggleHide(); }, {passive:false});
  $("useBtn").addEventListener("pointerdown",(e)=>{ e.preventDefault(); e.stopPropagation(); if(game.playing) pickupOrInteract(); }, {passive:false});
  $("pauseBtn").addEventListener("pointerdown",(e)=>{ e.preventDefault(); e.stopPropagation(); if(game.playing) openPause(); }, {passive:false});
}
bindPad();

window.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowUp"||e.key==="w") keys.up=true;
  if(e.key==="ArrowDown"||e.key==="s") keys.down=true;
  if(e.key==="ArrowLeft"||e.key==="a") keys.left=true;
  if(e.key==="ArrowRight"||e.key==="d") keys.right=true;
  if(e.key==="Shift") sprintHeld=true;
  if(e.key===" ") { if(game.playing) pickupOrInteract(); }
  if(e.key==="Escape") { if(game.playing) openPause(); }
},{passive:false});

window.addEventListener("keyup",(e)=>{
  if(e.key==="ArrowUp"||e.key==="w") keys.up=false;
  if(e.key==="ArrowDown"||e.key==="s") keys.down=false;
  if(e.key==="ArrowLeft"||e.key==="a") keys.left=false;
  if(e.key==="ArrowRight"||e.key==="d") keys.right=false;
  if(e.key==="Shift") sprintHeld=false;
},{passive:false});

/* =========================
   Hiding
========================= */
function canHideHere(){
  const tx=Math.round(player.x), ty=Math.round(player.y);
  if(!inb(tx,ty)) return false;
  for(let oy=-1;oy<=1;oy++){
    for(let ox=-1;ox<=1;ox++){
      const nx=tx+ox, ny=ty+oy;
      if(inb(nx,ny) && hideSpot[idx(nx,ny)]) return true;
    }
  }
  return false;
}
function toggleHide(){
  if(player.hideCooldown>0) return;
  if(player.hidden){
    player.hidden=false;
    player.hideCooldown=0.35;
    toast("Unhid.");
    return;
  }
  if(!canHideHere()) return toast("No hiding spot nearby.");
  player.hidden=true;
  player.hideCooldown=0.35;
  toast("Hidden.");
}

/* =========================
   Pickup
========================= */
function pickupOrInteract(){
  const px=Math.round(player.x), py=Math.round(player.y);
  for(const it of items){
    if(it.taken) continue;
    const d = Math.abs(it.x-px)+Math.abs(it.y-py);
    if(d<=1){
      it.taken=true;
      invAdd(it.kind);
      if(game.multiplayer) mpMarkPickupTaken(it);
      return;
    }
  }
  toast("Nothing to pick up.");
}

/* =========================
   Run control
========================= */
function resetRun(difficultyKey){
  game.params = diffParams(difficultyKey);
  game.difficultyKey = difficultyKey;
  game.inGameMinute = DAY_START_MIN;
  game.playSecondsThisRun=0;

  player.x=14; player.y=14;
  player.vx=0; player.vy=0;
  player.health=100; player.hunger=100; player.thirst=100; player.stamina=100;
  player.hidden=false; player.hideCooldown=0; player.damageCooldown=0;
  player.ornaments=0;

  for(const it of items) it.taken=false;

  enemies=[];
  const p=game.params;
  for(let i=0;i<p.enemyCount;i++) enemies.push(makeEnemy(rand(20,100), rand(20,65), i%3));

  renderInv();
  updateHud();
}

function winRun(){
  game.playing=false;
  game.paused=false;
  SAVE.survivedTotal++;
  SAVE.survivedStreak++;
  SAVE.bestStreak = Math.max(SAVE.bestStreak, SAVE.survivedStreak);
  if(SAVE.survivedTotal>=5) SAVE.unlocks.medium=true;
  if(SAVE.survivedTotal>=10) SAVE.unlocks.hard=true;
  saveNow();
  toast("You survived!");
  setTimeout(()=>showMenu(), 700);
}
function loseRun(){
  game.playing=false;
  game.paused=false;
  SAVE.survivedStreak=0;
  saveNow();
  toast("You got caught...");
  setTimeout(()=>showMenu(), 700);
}
function showMenu(){
  game.inMenu=true;
  game.playing=false;
  game.paused=false;
  $("mpLeaveBtn").style.display = "none";
  showScreen("menuScreen");
  refreshMenuLocks();
}
function startSolo(){
  game.multiplayer=false;
  game.mp.enabled=false;
  const diff=$("diffSelect").value;
  SAVE.lastDifficulty=diff;
  saveNow();
  resetRun(diff);
  game.playing=true;
  game.inMenu=false;
  showScreen(null);
  toast("Survive till 8:00 AM!");
}
function startFromRoom(diffKey){
  game.multiplayer=true;
  game.mp.enabled=true;
  resetRun(diffKey);
  game.playing=true;
  game.inMenu=false;
  showScreen(null);
  toast("Multiplayer started!");
}
function openPause(){
  game.paused=true;
  $("pauseInfo").innerHTML = `
    <b>${esc(SAVE.name)}</b><br>
    Time: ${esc(formatTimeFromMinutes(game.inGameMinute))}<br>
    Difficulty: ${esc(game.difficultyKey)}
  `;
  $("mpLeaveBtn").style.display = game.multiplayer ? "inline-block" : "none";
  showScreen("pauseScreen");
}

/* =========================
   HUD
========================= */
function setBar(fillEl, txtEl, v){
  v=clamp(v,0,100);
  txtEl.textContent = Math.round(v);
  fillEl.style.width = `${v}%`;
}
function updateHud(){
  $("timeText").textContent = formatTimeFromMinutes(game.inGameMinute);
  const d=game.difficultyKey;
  $("diffBadge").textContent = (d==="santa" ? "üéÖ Santa" : d[0].toUpperCase()+d.slice(1));
  $("diffBadge").className = "badge " + (d==="hard" ? "bad" : d==="medium" ? "warn" : "good");

  setBar($("hpFill"), $("hpText"), player.health);
  setBar($("hunFill"), $("hunText"), player.hunger);
  setBar($("thrFill"), $("thrText"), player.thirst);
  setBar($("staFill"), $("staText"), player.stamina);

  if(game.difficultyKey==="santa"){
    $("goalText").textContent = `üéÖ Find 5 ornaments (${player.ornaments}/5) OR survive to 8:00 AM`;
  }else{
    $("goalText").textContent = `Survive until 8:00 AM ‚Ä¢ 1 sec = 1 in-game minute`;
  }
}

/* =========================
   Collision
========================= */
function isSolidAt(x,y){
  const tx=Math.floor(x), ty=Math.floor(y);
  if(!inb(tx,ty)) return true;
  return solid[idx(tx,ty)]===1;
}
function moveWithCollision(nx,ny){
  const r=0.22;
  let x=player.x, y=player.y;
  if(!isSolidAt(nx+r,y) && !isSolidAt(nx-r,y)) x=nx;
  if(!isSolidAt(x,ny+r) && !isSolidAt(x,ny-r)) y=ny;
  player.x=x; player.y=y;
}

/* =========================
   Enemy logic
========================= */
function dist(a,b,c,d){ return Math.hypot(a-c,b-d); }
function enemyCanSee(e){
  if(player.hidden) return false;
  const d=dist(e.x,e.y,player.x,player.y);
  if(d>game.params.enemySight) return false;
  const steps = Math.ceil(d*4);
  for(let i=1;i<steps;i++){
    const t=i/steps;
    const sx=lerp(e.x,player.x,t);
    const sy=lerp(e.y,player.y,t);
    if(isSolidAt(sx,sy)) return false;
  }
  return true;
}
function enemyPickPatrolTarget(e){
  e.tx = clamp(Math.floor(e.x) + rand(-10,10), 6, WORLD_W-7);
  e.ty = clamp(Math.floor(e.y) + rand(-8,8), 6, WORLD_H-7);
}
function enemyStep(e, dt){
  if(e.hitCooldown>0) e.hitCooldown-=dt;

  const speed = game.params.enemySpeed;
  const sees = enemyCanSee(e);
  if(sees){
    e.mode="chase";
    e.spotTimer = 0.65;
  }else{
    e.spotTimer = Math.max(0, e.spotTimer - dt);
    if(e.spotTimer<=0) e.mode="patrol";
  }

  let tx=e.tx, ty=e.ty;
  if(e.mode==="chase"){
    tx = player.x; ty = player.y;
  }else{
    if(dist(e.x,e.y,e.tx,e.ty)<0.8) enemyPickPatrolTarget(e);
  }

  const dx=tx-e.x, dy=ty-e.y;
  const d=Math.hypot(dx,dy)||1;
  const vx = (dx/d)*speed;
  const vy = (dy/d)*speed;

  const nx=e.x + vx*dt*3.2;
  const ny=e.y + vy*dt*3.2;

  if(!isSolidAt(nx, e.y)) e.x=nx;
  if(!isSolidAt(e.x, ny)) e.y=ny;

  const hitD = dist(e.x,e.y,player.x,player.y);
  if(hitD<0.75 && e.hitCooldown<=0){
    e.hitCooldown=1.05;
    if(player.damageCooldown<=0){
      player.health = clamp(player.health - 30, 0, 100);
      player.damageCooldown=0.8;
      toast("Employee hit you! -30 HP");
      if(player.health<=0) loseRun();
    }
  }
}

/* =========================
   Drawing
========================= */
function drawTile(x,y,t){
  if(t===T.FLOOR){
    ctx.fillStyle="#111a2e"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="rgba(255,255,255,.03)"; ctx.fillRect(x+2,y+2,2,2);
  }else if(t===T.CARPET){
    ctx.fillStyle="#2b1635"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="rgba(255,210,240,.08)"; ctx.fillRect(x+3,y+3,2,2);
  }else if(t===T.SHOP){
    ctx.fillStyle="#132a1d"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="rgba(255,255,255,.04)"; ctx.fillRect(x+2,y+11,3,2);
  }else if(t===T.WALL){
    ctx.fillStyle="#3a4a6f"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="rgba(0,0,0,.25)"; ctx.fillRect(x,y,2,TILE);
    ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(x+2,y+2,TILE-4,2);
  }else if(t===T.GLASS){
    ctx.fillStyle="#6bc7ff"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="rgba(0,0,0,.25)"; ctx.fillRect(x,y,2,TILE);
    ctx.fillStyle="rgba(255,255,255,.35)"; ctx.fillRect(x+3,y+3,3,3);
  }else if(t===T.DOOR){
    ctx.fillStyle="#8b5a2b"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="rgba(0,0,0,.22)"; ctx.fillRect(x+2,y+2,TILE-4,TILE-4);
    ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(x+4,y+4,2,2);
  }else if(t===T.KIOSK){
    ctx.fillStyle="#c7a66a"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="#7a5a2b"; ctx.fillRect(x+2,y+2,TILE-4,TILE-4);
    ctx.fillStyle="rgba(255,255,255,.12)"; ctx.fillRect(x+3,y+3,3,3);
  }else if(t===T.PLANT){
    ctx.fillStyle="#1b2a18"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="#1f6b34"; ctx.fillRect(x+4,y+4,8,8);
    ctx.fillStyle="#2fd66b"; ctx.fillRect(x+6,y+3,4,2);
    ctx.fillStyle="#7b4a2b"; ctx.fillRect(x+7,y+12,2,2);
  }else if(t===T.LOCKER){
    ctx.fillStyle="#2f3a55"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="#99a7cc"; ctx.fillRect(x+3,y+2,10,12);
    ctx.fillStyle="rgba(0,0,0,.22)"; ctx.fillRect(x+8,y+2,1,12);
    ctx.fillStyle="#2f3a55"; ctx.fillRect(x+5,y+6,2,2);
    ctx.fillRect(x+10,y+6,2,2);
  }else if(t===T.TREE){
    ctx.fillStyle="#2a3b1c"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="#1f7a3a"; ctx.fillRect(x+4,y+2,8,10);
    ctx.fillStyle="#2fd66b"; ctx.fillRect(x+5,y+3,6,2);
    ctx.fillStyle="#e64d6a"; ctx.fillRect(x+4,y+7,2,2);
    ctx.fillStyle="#ffd36b"; ctx.fillRect(x+10,y+6,2,2);
    ctx.fillStyle="#7b4a2b"; ctx.fillRect(x+7,y+12,2,3);
  }else if(t===T.TABLE){
    ctx.fillStyle="#5c3b23"; ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="#8b5a2b"; ctx.fillRect(x+2,y+2,TILE-4,5);
    ctx.fillStyle="rgba(0,0,0,.25)"; ctx.fillRect(x+3,y+7,TILE-6,2);
  }else{
    ctx.fillStyle="#111a2e"; ctx.fillRect(x,y,TILE,TILE);
  }
}
function drawItem(it, sx, sy){
  const kind=it.kind;
  if(kind.type==="food"){
    ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(sx+4,sy+10,8,4);
    ctx.fillStyle="#ffd36b"; ctx.fillRect(sx+5,sy+9,6,2);
    ctx.fillStyle="#7a2b3b"; ctx.fillRect(sx+5,sy+11,6,2);
  }else if(kind.type==="drink"){
    ctx.fillStyle="#6bc7ff"; ctx.fillRect(sx+6,sy+6,4,8);
    ctx.fillStyle="rgba(255,255,255,.35)"; ctx.fillRect(sx+7,sy+7,1,5);
    if(kind.name==="soda"){ ctx.fillStyle="#ff6b7a"; ctx.fillRect(sx+5,sy+5,6,2); }
  }else if(kind.type==="ornament"){
    ctx.fillStyle="#ffd36b"; ctx.fillRect(sx+7,sy+5,2,2);
    ctx.fillStyle="#ff6b7a"; ctx.fillRect(sx+6,sy+7,4,4);
    ctx.fillStyle="rgba(255,255,255,.25)"; ctx.fillRect(sx+6,sy+7,2,2);
  }
}
function drawPlayer(sx,sy, isOther=false){
  const c1 = isOther ? "#67f0a5" : "#7bdcff";
  const c2 = isOther ? "#1e5640" : "#24365a";

  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(sx-6, sy+6, 12, 3);
  ctx.fillStyle=c2; ctx.fillRect(sx-4, sy+2, 3, 5); ctx.fillRect(sx+1, sy+2, 3, 5);
  ctx.fillStyle=c1; ctx.fillRect(sx-5, sy-3, 10, 7);

  ctx.fillStyle="#ff6b7a"; ctx.fillRect(sx-5, sy-1, 10, 2); ctx.fillRect(sx+3, sy+1, 2, 4);
  ctx.fillStyle="#f2c7a3"; ctx.fillRect(sx-4, sy-9, 8, 6);
  ctx.fillStyle="#2b1635"; ctx.fillRect(sx-4, sy-9, 8, 2);
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(sx-2, sy-6, 1, 1); ctx.fillRect(sx+1, sy-6, 1, 1);

  if(!isOther && player.hidden){
    ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(sx-7, sy-11, 14, 16);
    ctx.fillStyle="rgba(255,255,255,.12)"; ctx.fillRect(sx-6, sy-10, 12, 14);
  }
}
function drawEnemy(sx,sy, variant){
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(sx-6, sy+6, 12, 3);
  const top = variant===0 ? "#ffd36b" : variant===1 ? "#ff6b7a" : "#6bc7ff";
  const uni = "#3a4a6f";
  ctx.fillStyle=uni; ctx.fillRect(sx-4, sy+2, 3, 5); ctx.fillRect(sx+1, sy+2, 3, 5);
  ctx.fillStyle=top; ctx.fillRect(sx-5, sy-3, 10, 7);
  ctx.fillStyle="#e5b895"; ctx.fillRect(sx-4, sy-9, 8, 6);
  ctx.fillStyle="#111a2e"; ctx.fillRect(sx-4, sy-10, 8, 2);
  ctx.fillStyle="#ffffff"; ctx.fillRect(sx+2, sy-1, 2, 2);
}

/* =========================
   Camera + render
========================= */
let cam = {x:0,y:0};
function render(){
  const scale = Math.floor(Math.min(canvas.width/(VIEW_TILES_X*TILE), canvas.height/(VIEW_TILES_Y*TILE)));
  const rw = VIEW_TILES_X*TILE;
  const rh = VIEW_TILES_Y*TILE;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.imageSmoothingEnabled=false;
  ctx.fillStyle="#0b1220";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const targetX = player.x*TILE - rw/2;
  const targetY = player.y*TILE - rh/2;
  cam.x = lerp(cam.x, targetX, 0.14);
  cam.y = lerp(cam.y, targetY, 0.14);
  cam.x = clamp(cam.x, 0, WORLD_W*TILE - rw);
  cam.y = clamp(cam.y, 0, WORLD_H*TILE - rh);

  const ox = Math.floor((canvas.width - rw*scale)/2);
  const oy = Math.floor((canvas.height - rh*scale)/2);

  ctx.translate(ox, oy);
  ctx.scale(scale, scale);

  const startTx = Math.floor(cam.x / TILE);
  const startTy = Math.floor(cam.y / TILE);
  const endTx = startTx + VIEW_TILES_X + 2;
  const endTy = startTy + VIEW_TILES_Y + 2;

  for(let ty=startTy; ty<endTy; ty++){
    for(let tx=startTx; tx<endTx; tx++){
      if(!inb(tx,ty)) continue;
      const t = tile[idx(tx,ty)];
      const sx = tx*TILE - cam.x;
      const sy = ty*TILE - cam.y;
      drawTile(sx,sy,t);
    }
  }

  for(const it of items){
    if(it.taken) continue;
    drawItem(it, it.x*TILE - cam.x, it.y*TILE - cam.y);
  }

  if(game.multiplayer){
    for(const op of Object.values(game.mp.otherPlayers)){
      drawPlayer(op.x*TILE - cam.x + 8, op.y*TILE - cam.y + 8, true);
    }
  }

  for(const e of enemies) drawEnemy(e.x*TILE - cam.x + 8, e.y*TILE - cam.y + 8, e.variant);
  drawPlayer(player.x*TILE - cam.x + 8, player.y*TILE - cam.y + 8, false);

  // vignette
  ctx.setTransform(1,0,0,1,0,0);
  const g=ctx.createRadialGradient(canvas.width*0.5, canvas.height*0.5, canvas.width*0.2, canvas.width*0.5, canvas.height*0.55, canvas.width*0.62);
  g.addColorStop(0,"rgba(0,0,0,0.00)");
  g.addColorStop(1,"rgba(0,0,0,0.55)");
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

  const g2=ctx.createRadialGradient(canvas.width*0.5, canvas.height*0.12, 10, canvas.width*0.5, canvas.height*0.12, canvas.width*0.65);
  g2.addColorStop(0,"rgba(255,255,255,0.10)");
  g2.addColorStop(1,"rgba(255,255,255,0.00)");
  ctx.fillStyle=g2; ctx.fillRect(0,0,canvas.width,canvas.height);
}

/* =========================
   Loop
========================= */
function tick(now){
  const dt = Math.min(0.05, (now - game.lastTick)/1000);
  game.lastTick = now;

  if(game.playing && !game.paused){
    SAVE.totalPlaySeconds += dt;
    game.playSecondsThisRun += dt;

    // time: 1 real second = 1 in-game minute
    game.inGameMinute += dt * 1;

    if(game.inGameMinute>=DAY_END_MIN) winRun();

    const p=game.params;
    player.hunger = clamp(player.hunger - p.hungerDrain*dt*10, 0, 100);
    player.thirst = clamp(player.thirst - p.thirstDrain*dt*10, 0, 100);

    if(player.hunger<=0 || player.thirst<=0){
      player.health = clamp(player.health - 6*dt, 0, 100);
      if(player.health<=0) loseRun();
    }

    const moving = keys.up||keys.down||keys.left||keys.right;
    const wantSprint = sprintHeld && moving && !player.hidden;
    const canSprint = player.stamina>2;

    let spd = player.speed;
    if(wantSprint && canSprint){
      spd *= 1.55;
      player.stamina = clamp(player.stamina - p.staminaDrain*dt*18, 0, 100);
    }else{
      player.stamina = clamp(player.stamina + p.staminaRegen*dt*14, 0, 100);
    }

    if(player.hidden){
      player.vx=0; player.vy=0;
    }else{
      let mx=0,my=0;
      if(keys.left) mx-=1;
      if(keys.right) mx+=1;
      if(keys.up) my-=1;
      if(keys.down) my+=1;
      const mag=Math.hypot(mx,my) || 1;
      mx/=mag; my/=mag;

      player.vx = mx*spd;
      player.vy = my*spd;

      moveWithCollision(player.x + player.vx*dt*3.2, player.y + player.vy*dt*3.2);
    }

    if(player.hideCooldown>0) player.hideCooldown-=dt;
    if(player.damageCooldown>0) player.damageCooldown-=dt;

    for(const e of enemies) enemyStep(e, dt);

    if(game.difficultyKey==="santa" && player.ornaments>=5) winRun();

    if(game.multiplayer) mpTick(dt);

    updateHud();
  }

  if(game.playing) render();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* =========================
   Menu buttons
========================= */
$("playSoloBtn").onclick = ()=> startSolo();

$("howBtn").onclick = ()=> showScreen("howScreen");
$("howBackBtn").onclick = ()=> showScreen("menuScreen");

$("statsBtn").onclick = ()=>{
  const mins = Math.floor(SAVE.totalPlaySeconds/60);
  const secs = Math.floor(SAVE.totalPlaySeconds%60);
  $("statsText").innerHTML = `
    <b>Name:</b> ${esc(SAVE.name)}<br><br>
    <b>Total play time:</b> ${mins}m ${secs}s<br>
    <b>Total survives:</b> ${SAVE.survivedTotal}<br>
    <b>Survives in a row:</b> ${SAVE.survivedStreak}<br>
    <b>Best streak:</b> ${SAVE.bestStreak}<br><br>
    <b>Unlocked:</b> Medium = ${SAVE.unlocks.medium?"Yes":"No"} ‚Ä¢ Hard = ${SAVE.unlocks.hard?"Yes":"No"}
  `;
  showScreen("statsScreen");
};
$("statsBackBtn").onclick = ()=> showScreen("menuScreen");

$("resetBtn").onclick = ()=>{
  if(!confirm("Reset your local save?")) return;
  localStorage.removeItem(SAVE_KEY);
  SAVE=loadSave();
  saveNow();
  toast("Save reset.");
  showScreen("menuScreen");
};

$("resumeBtn").onclick = ()=>{ game.paused=false; showScreen(null); };
$("quitBtn").onclick = ()=>{ game.paused=false; if(game.multiplayer) mpLeaveRoom(); showMenu(); };
$("mpLeaveBtn").onclick = ()=>{ mpLeaveRoom(); showMenu(); };

$("nameInput").value = SAVE.name;
$("nameInput").addEventListener("input", ()=>{
  SAVE.name = $("nameInput").value.trim() || SAVE.name;
  saveNow();
});

$("diffSelect").value = SAVE.lastDifficulty || "easy";
$("diffSelect").addEventListener("change", ()=>{
  SAVE.lastDifficulty = $("diffSelect").value;
  saveNow();
});

renderInv();
updateHud();

/* =========================================================
   MULTIPLAYER ‚Äî Firebase RTDB
========================================================= */
const MP = game.mp;
function r(path){ return ref(db, path); }

function makeRoomCode(){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<6;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}

async function mpCreateRoom(maxPlayers, diffKey){
  const code = makeRoomCode();
  MP.roomId = code;
  MP.isHost = true;
  MP.otherPlayers = {};

  await set(r(`rooms/${code}`), {
    hostId: MP.playerId,
    hostName: SAVE.name,
    maxPlayers,
    diffKey,
    started:false,
    createdAt: serverTimestamp()
  });

  await set(r(`publicRooms/${code}`), {
    hostName: SAVE.name,
    maxPlayers,
    diffKey,
    started:false,
    createdAt: Date.now()
  });

  await set(r(`rooms/${code}/players/${MP.playerId}`), {
    id: MP.playerId,
    name: SAVE.name,
    x: player.x, y: player.y,
    hp: player.health,
    hidden: false,
    ornaments: 0,
    joinedAt: serverTimestamp()
  });

  onDisconnect(r(`rooms/${code}/players/${MP.playerId}`)).remove();
  onDisconnect(r(`publicRooms/${code}`)).remove();

  mpWatchRoom();
  mpWatchPickups();
  return code;
}

async function mpJoinRoom(code){
  code = code.toUpperCase().trim();
  const snap = await get(r(`rooms/${code}`));
  if(!snap.exists()) return toast("Server not found.");
  const room = snap.val();
  if(room.started) return toast("Already started.");

  const playersSnap = await get(r(`rooms/${code}/players`));
  const count = playersSnap.exists() ? Object.keys(playersSnap.val()).length : 0;
  if(count >= room.maxPlayers) return toast("Server full.");

  MP.roomId = code;
  MP.isHost = false;
  MP.otherPlayers = {};

  await set(r(`rooms/${code}/players/${MP.playerId}`), {
    id: MP.playerId,
    name: SAVE.name,
    x: player.x, y: player.y,
    hp: player.health,
    hidden: false,
    ornaments: 0,
    joinedAt: serverTimestamp()
  });

  onDisconnect(r(`rooms/${code}/players/${MP.playerId}`)).remove();
  mpWatchRoom();
  mpWatchPickups();
}

function mpWatchPublicRooms(){
  const list=$("serverList");
  if(MP.roomsUnsub) MP.roomsUnsub();

  MP.roomsUnsub = onValue(r("publicRooms"), (snap)=>{
    const rooms = snap.val() || {};
    const arr = Object.entries(rooms)
      .map(([id,v])=>({id,...v}))
      .filter(v=>!v.started)
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    if(!arr.length){
      list.innerHTML = `<div class="muted">No servers right now.</div>`;
      return;
    }

    list.innerHTML = arr.map(s=>`
      <div class="serverRow">
        <div>
          <div><b>${esc(s.hostName)}‚Äôs Server</b></div>
          <div class="tiny muted">Max ${s.maxPlayers} ‚Ä¢ ${esc(s.diffKey)}</div>
        </div>
        <button class="btn small" data-join="${s.id}">Join</button>
      </div>
    `).join("");

    list.querySelectorAll("button[data-join]").forEach(btn=>{
      btn.addEventListener("click", ()=> mpJoinRoom(btn.getAttribute("data-join")));
    });
  });
}

function mpWatchRoom(){
  if(MP.roomUnsub) MP.roomUnsub();

  MP.roomUnsub = onValue(r(`rooms/${MP.roomId}`), (snap)=>{
    const room = snap.val();
    if(!room){
      toast("Room closed.");
      mpLeaveRoom();
      showMenu();
      return;
    }

    MP.hostId = room.hostId;

    if(!room.started && !game.playing){
      showScreen("lobbyScreen");
      const players = Object.values(room.players||{});
      $("lobbyInfo").innerHTML =
        `<b>${esc(room.hostName)}‚Äôs Server</b> ‚Ä¢ ${esc(room.diffKey)} ‚Ä¢ ${players.length}/${room.maxPlayers}<br>` +
        `<span class="tiny muted">Room code: <b>${esc(MP.roomId)}</b></span>`;

      $("playerList").innerHTML = players.map((p,i)=>`<div style="padding:6px 0;"><b>${i+1}.</b> ${esc(p.name)}</div>`).join("");

      const isHostNow = (room.hostId === MP.playerId);
      $("hostStartBtn").style.display = isHostNow ? "inline-block" : "none";
      $("hostStartBtn").disabled = players.length < 2;
    }

    if(room.started && !game.playing){
      game.multiplayer=true;
      game.mp.enabled=true;
      startFromRoom(room.diffKey);
    }

    if(game.playing){
      const playersObj = room.players||{};
      const others={};
      for(const [pid,p] of Object.entries(playersObj)){
        if(pid===MP.playerId) continue;
        others[pid]=p;
      }
      MP.otherPlayers = others;
    }
  });
}

async function mpStartRoom(){
  if(!MP.roomId) return;
  const snap = await get(r(`rooms/${MP.roomId}/players`));
  const count = snap.exists() ? Object.keys(snap.val()).length : 0;
  if(count<2) return toast("Need at least 2 players.");
  await update(r(`rooms/${MP.roomId}`), { started:true });
  await update(r(`publicRooms/${MP.roomId}`), { started:true });
}

async function mpLeaveRoom(){
  if(!MP.roomId) return;

  await remove(r(`rooms/${MP.roomId}/players/${MP.playerId}`));

  const roomSnap = await get(r(`rooms/${MP.roomId}`));
  const room = roomSnap.val();
  const host = room && room.hostId === MP.playerId;

  if(host){
    await remove(r(`publicRooms/${MP.roomId}`));
    await remove(r(`rooms/${MP.roomId}`));
  }

  if(MP.roomsUnsub) { MP.roomsUnsub(); MP.roomsUnsub=null; }
  if(MP.roomUnsub) { MP.roomUnsub(); MP.roomUnsub=null; }

  MP.roomId=null;
  MP.isHost=false;
  MP.hostId=null;
  MP.otherPlayers={};

  game.multiplayer=false;
  game.mp.enabled=false;
}

function mpTick(dt){
  if(!MP.roomId) return;
  mpTick._t = (mpTick._t||0) + dt;
  if(mpTick._t < 0.10) return;
  mpTick._t = 0;

  update(r(`rooms/${MP.roomId}/players/${MP.playerId}`), {
    x: player.x, y: player.y,
    hp: player.health,
    hidden: player.hidden,
    ornaments: player.ornaments,
    t: Date.now()
  }).catch(()=>{});
}

function mpMarkPickupTaken(it){
  if(!MP.roomId) return;
  const i = items.indexOf(it);
  if(i<0) return;
  update(r(`rooms/${MP.roomId}/pickups/${i}`), { taken:true }).catch(()=>{});
}

function mpWatchPickups(){
  if(!MP.roomId) return;
  onValue(r(`rooms/${MP.roomId}/pickups`), (snap)=>{
    const p = snap.val()||{};
    for(const [k,v] of Object.entries(p)){
      const i = Number(k);
      if(Number.isFinite(i) && items[i]) items[i].taken = !!v.taken;
    }
  });
}

/* ===== Multiplayer UI ===== */
$("multiBtn").onclick = ()=>{
  $("hostPanel").style.display="none";
  $("joinPanel").style.display="none";
  showScreen("multiScreen");
};
$("multiBackBtn").onclick = ()=> showScreen("menuScreen");

$("hostBtn").onclick = ()=>{
  $("hostPanel").style.display="block";
  $("joinPanel").style.display="none";
  $("hostDiffSelect").value = $("diffSelect").value || "easy";
};

$("joinBtn").onclick = ()=>{
  $("hostPanel").style.display="none";
  $("joinPanel").style.display="block";
  mpWatchPublicRooms();
};

$("refreshServersBtn").onclick = ()=> mpWatchPublicRooms();

$("createServerBtn").onclick = async ()=>{
  const maxPlayers = parseInt($("maxPlayersSelect").value,10);
  const diffKey = $("hostDiffSelect").value;
  if(diffKey==="medium" && !SAVE.unlocks.medium) return toast("Medium locked (survive 5x).");
  if(diffKey==="hard" && !SAVE.unlocks.hard) return toast("Hard locked (survive 10x).");
  toast("Creating server...");
  await mpCreateRoom(maxPlayers, diffKey);
};

$("lobbyLeaveBtn").onclick = async ()=>{
  await mpLeaveRoom();
  showScreen("multiScreen");
};

$("hostStartBtn").onclick = async ()=>{ await mpStartRoom(); };

/* =========================
   Start
========================= */
function showMenuStart(){
  game.inMenu=true;
  game.playing=false;
  game.paused=false;
  showScreen("menuScreen");
  refreshMenuLocks();
}
showMenuStart();
render();
</script>
</body>
</html>
